name: 91ktvç›´æ’­æºæ¯æ—¥æ›´æ–°
on: 
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©UTCæ—¶é—´3ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´11ç‚¹ï¼‰

jobs:
  generate-and-overwrite:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: å®‰è£…ä¾èµ–
      run: npm install axios crypto-js

    - name: ç”Ÿæˆç›´æ’­æºæ–‡ä»¶
      run: |
        # åˆ›å»ºç›´æ¥è§†é¢‘æµç”Ÿæˆè„šæœ¬
        cat > generate.js << 'EOF'
        const axios = require('axios');
        const CryptoJS = require('crypto-js');
        const fs = require('fs');
        
        // è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        function getBeijingTime() {
          const now = new Date();
          const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
          return beijingTime.toISOString().replace('T', ' ').replace(/\.\d+Z/, '');
        }
        
        // æ¸…ç†é¢‘é“åç§°ï¼Œç”¨äºå½’ç±»
        function cleanChannelName(channelName) {
          if (!channelName) return '';
          
          // ç§»é™¤æºè´¨é‡æ ‡è¯†å’Œæ‹¬å·å†…å®¹
          let cleaned = channelName
            .replace(/\s*\([^)]*\)\s*/g, '')  // ç§»é™¤æ‹¬å·åŠå†…å®¹
            .replace(/\s*ï¼ˆ[^ï¼‰]*ï¼‰\s*/g, '')  // ç§»é™¤ä¸­æ–‡æ‹¬å·åŠå†…å®¹
            .replace(/\s*cdn\d+k\d+p\s*/gi, '')  // ç§»é™¤cdnè´¨é‡æ ‡è¯†
            .replace(/\s*[\[\]ã€ã€‘].*?[\[\]ã€ã€‘]\s*/g, '')  // ç§»é™¤æ–¹æ‹¬å·å†…å®¹
            .trim();
          
          // å¸¸è§é¢‘é“åç§°æ ‡å‡†åŒ–
          const standardNames = {
            'CCTV1': 'CCTV-1',
            'CCTV2': 'CCTV-2',
            'CCTV5': 'CCTV-5',
            'CCTV5+': 'CCTV-5+',
            'CCTV6': 'CCTV-6',
            'CCTV13': 'CCTV-13',
            'æ¹–å—å«è§†': 'æ¹–å—å«è§†',
            'æ±Ÿè‹å«è§†': 'æ±Ÿè‹å«è§†',
            'æµ™æ±Ÿå«è§†': 'æµ™æ±Ÿå«è§†',
            'åŒ—äº¬å«è§†': 'åŒ—äº¬å«è§†',
            'ä¸œæ–¹å«è§†': 'ä¸œæ–¹å«è§†'
          };
          
          // å°è¯•åŒ¹é…æ ‡å‡†åŒ–åç§°
          for (const [standard, normalized] of Object.entries(standardNames)) {
            if (cleaned.includes(standard)) {
              return normalized;
            }
          }
          
          return cleaned || channelName;
        }
        
        // æå–æºè´¨é‡ä¿¡æ¯
        function extractSourceInfo(sourceName) {
          if (!sourceName) return '';
          
          const matches = sourceName.match(/\((.*?)\)|ï¼ˆ(.*?)ï¼‰|\[(.*?)\]/);
          if (matches) {
            for (let i = 1; i < matches.length; i++) {
              if (matches[i]) return matches[i].trim();
            }
          }
          
          // åŒ¹é…å¸¸è§çš„è´¨é‡æ¨¡å¼
          const qualityMatch = sourceName.match(/(\d+k\d+p|é«˜æ¸…|è¶…æ¸…|4K|1080p|720p|æ ‡æ¸…)/i);
          if (qualityMatch) return qualityMatch[0];
          
          return sourceName;
        }
        
        // è·å–çœŸæ­£çš„è§†é¢‘æµåœ°å€
        async function getRealStreamUrl(sourceUrl) {
          try {
            // å¤„ç†è‡ªå®šä¹‰åè®®
            if (sourceUrl.startsWith('kdsvod://')) {
              sourceUrl = sourceUrl.replace('kdsvod://', '');
            }
            
            // å¤„ç†åŠ å¯†URL
            if (sourceUrl.includes('pwd=jsdecode') && sourceUrl.includes('id=')) {
              const urlObj = new URL(sourceUrl);
              const id = urlObj.searchParams.get('id');
              const bt = urlObj.searchParams.get('bt');
              
              const nwtime = Math.floor(Date.now() / 1000);
              const params = {
                app: 'com.jiaoxiang.fangnale',
                version: '2.3.4',
                mac: 'fu:ck:92:92:ff',
                utk: '',
                nwtime: nwtime,
                ev: '20250113'
              };
              
              const appendStr = 'ahkajfkahlajjaflfakhfakfbuyaozaigaolefuquqikangbuzhu';
              let signStr = id;
              
              Object.keys(params).forEach(key => {
                if (key === 'tmk') return;
                signStr += (key === 'app') ? params[key] + appendStr : params[key];
              });
              
              params.sign = CryptoJS.MD5(signStr).toString();
              
              // æ„å»ºçœŸå®è§†é¢‘æµURL
              let realUrl = `${urlObj.origin}${urlObj.pathname}?`;
              if (bt) realUrl += `bt=${bt}&`;
              realUrl += `id=${id}`;
              Object.keys(params).forEach(k => {
                realUrl += `&${k}=${encodeURIComponent(params[k])}`;
              });
              
              return realUrl;
            }
            
            return sourceUrl;
          } catch (e) {
            console.error('è§£æè§†é¢‘æµåœ°å€å¤±è´¥:', e.message);
            return sourceUrl;
          }
        }
        
        // ä¸»å‡½æ•°
        (async () => {
          console.log('å¼€å§‹ç”Ÿæˆ91çœ‹ç”µè§†ç›´æ’­æº...');
          const updateTime = getBeijingTime();
          
          // æ ¸å¿ƒåˆ†ç±»
          const categories = [
            'å¤®è§†', 'å«è§†', 'é«˜æ¸…', '4K', 'å½±è§†', 'ä½“è‚²', 'æ–°é—»'
          ];
          
          let m3uContent = '#EXTM3U\n';
          m3uContent += `# 91KTVç›´æ’­æº - æœ€åæ›´æ–°: ${updateTime} (åŒ—äº¬æ—¶é—´)\n`;
          m3uContent += `# é¢‘é“æ€»æ•°: \n`;
          m3uContent += `# æºæ€»æ•°: \n`;
          m3uContent += `# ç”Ÿæˆæ–¹å¼: GitHub Actionsè‡ªåŠ¨æ›´æ–°\n\n`;
          
          let channelCount = 0;
          let sourceCount = 0;
          
          // å­˜å‚¨å½’ç±»åçš„é¢‘é“ä¿¡æ¯
          const channelMap = new Map();
          
          // å¤„ç†æ‰€æœ‰åˆ†ç±»
          for (const category of categories) {
            console.log(`å¼€å§‹å¤„ç†åˆ†ç±»: ${category}`);
            
            try {
              // è·å–é¢‘é“åˆ—è¡¨ - æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„APIé“¾æ¥
              const channelsRes = await axios.get(
                `YOUR_API_URL_1${encodeURIComponent(category)}`, // æ›¿æ¢ä¸ºå®é™…é“¾æ¥
                { timeout: 5000, headers: {'User-Agent': 'Mozilla/5.0'} }
              );
              
              if (!channelsRes.data || !Array.isArray(channelsRes.data)) {
                console.log(`åˆ†ç±» ${category} æ— æ•°æ®`);
                continue;
              }
              
              console.log(`åˆ†ç±» ${category} æœ‰ ${channelsRes.data.length} ä¸ªé¢‘é“`);
              
              // å¤„ç†æ¯ä¸ªé¢‘é“
              for (const channel of channelsRes.data) {
                const nwtime = Math.floor(Date.now() / 1000);
                const srcKey = `${channel.ename}com.jiaoxiang.fangnaleahkajfkahlajjaflfakhfakfbuyaozaigaolefuquqikangbuzhu2.3.4fu:ck:92:92:ff${nwtime}20240918`;
                const sign = CryptoJS.MD5(srcKey).toString();
                
                try {
                  // è·å–æ’­æ”¾æº - æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„APIé“¾æ¥
                  const sourceRes = await axios.get(
                    `YOUR_API_URL_2${channel.ename}&app=com.jiaoxiang.fangnale&version=2.3.4&mac=fu:ck:92:92:ff&nwtime=${nwtime}&sign=${sign}&ev=20240918`, // æ›¿æ¢ä¸ºå®é™…é“¾æ¥
                    { timeout: 5000, headers: {'User-Agent': 'Mozilla/5.0'} }
                  );
                  
                  // æ£€æŸ¥æ˜¯å¦æœ‰æ’­æ”¾æº
                  if (sourceRes.data?.liveSource && Array.isArray(sourceRes.data.liveSource)) {
                    const sources = sourceRes.data.liveSource;
                    const sourceNames = sourceRes.data.liveSourceName || [];
                    
                    // æ¸…ç†é¢‘é“åç§°ç”¨äºå½’ç±»
                    const cleanName = cleanChannelName(channel.name);
                    const baseChannelName = cleanName || channel.name;
                    
                    // åˆå§‹åŒ–é¢‘é“ä¿¡æ¯
                    if (!channelMap.has(baseChannelName)) {
                      channelMap.set(baseChannelName, {
                        name: baseChannelName,
                        ename: channel.ename,
                        icon: channel.icon,
                        category: category,
                        sources: []
                      });
                    }
                    
                    const channelInfo = channelMap.get(baseChannelName);
                    
                    // å¤„ç†æ¯ä¸ªæ’­æ”¾æº
                    for (let i = 0; i < sources.length; i++) {
                      let sourceUrl = sources[i];
                      const sourceName = sourceNames[i] || '';
                      
                      // è·å–çœŸæ­£çš„è§†é¢‘æµåœ°å€
                      const realStreamUrl = await getRealStreamUrl(sourceUrl);
                      
                      // æå–æºè´¨é‡ä¿¡æ¯
                      const sourceQuality = extractSourceInfo(sourceName);
                      
                      channelInfo.sources.push({
                        url: realStreamUrl,
                        quality: sourceQuality,
                        fullName: sourceName
                      });
                      
                      sourceCount++;
                    }
                    
                    channelCount++;
                  }
                } catch (e) {
                  console.log(`è·³è¿‡é¢‘é“ ${channel.name}: ${e.message}`);
                }
                
                // çŸ­æš‚å»¶è¿Ÿ
                await new Promise(r => setTimeout(r, 50));
              }
            } catch (e) {
              console.log(`å¤„ç†åˆ†ç±» ${category} å‡ºé”™: ${e.message}`);
            }
          }
          
          // ç”Ÿæˆæœ€ç»ˆçš„m3uå†…å®¹
          for (const [channelName, channelInfo] of channelMap.entries()) {
            // å¦‚æœæœ‰å¤šä¸ªæºï¼ŒæŒ‰è´¨é‡æ’åºï¼ˆé«˜è´¨é‡åœ¨å‰ï¼‰
            if (channelInfo.sources.length > 1) {
              channelInfo.sources.sort((a, b) => {
                const qualityOrder = {
                  '4K': 100, '2160p': 95, '1080p': 90, 'é«˜æ¸…': 85, 
                  '720p': 80, 'è¶…æ¸…': 75, 'æ ‡æ¸…': 70, '480p': 65, '360p': 60
                };
                
                const aScore = qualityOrder[a.quality] || 50;
                const bScore = qualityOrder[b.quality] || 50;
                return bScore - aScore;
              });
            }
            
            // ä¸ºæ¯ä¸ªæºç”Ÿæˆæ¡ç›®
            for (let i = 0; i < channelInfo.sources.length; i++) {
              const source = channelInfo.sources[i];
              let displayName = channelName;
              
              // å¦‚æœæœ‰å¤šä¸ªæºï¼Œåœ¨æ˜¾ç¤ºåç§°ä¸­æ·»åŠ è´¨é‡æ ‡è¯†
              if (channelInfo.sources.length > 1) {
                const qualityLabel = source.quality ? `[${source.quality}]` : `[æº${i+1}]`;
                displayName = `${channelName} ${qualityLabel}`;
              }
              
              m3uContent += `#EXTINF:-1 tvg-id="${channelInfo.ename}" tvg-name="${channelName}" tvg-logo="${channelInfo.icon}" group-title="${channelInfo.category}",${displayName}\n`;
              m3uContent += `${source.url}\n`;
            }
          }
          
          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          m3uContent = m3uContent.replace('# é¢‘é“æ€»æ•°: \n', `# é¢‘é“æ€»æ•°: ${channelMap.size}\n`);
          m3uContent = m3uContent.replace('# æºæ€»æ•°: \n', `# æºæ€»æ•°: ${sourceCount}\n`);
          
          // è¦†ç›–å†™å…¥æ–‡ä»¶
          fs.writeFileSync('91ktv.m3u', m3uContent);
          console.log(`å®Œæˆ! å…±è·å– ${channelMap.size} ä¸ªå½’ç±»é¢‘é“ï¼Œ${sourceCount} ä¸ªè§†é¢‘æµï¼Œæ›´æ–°æ—¶é—´: ${updateTime}`);
          
          // è¾“å‡ºå½’ç±»ç»Ÿè®¡
          console.log('\\nå½’ç±»ç»Ÿè®¡:');
          for (const [name, info] of channelMap.entries()) {
            if (info.sources.length > 1) {
              console.log(`  ${name}: ${info.sources.length}ä¸ªæº`);
            }
          }
        })().catch(console.error);
        EOF
        
        # è¿è¡Œç”Ÿæˆè„šæœ¬
        node generate.js

    - name: è¦†ç›–æ›´æ–°æ–‡ä»¶
      run: |
        # è·å–å½“å‰åŒ—äº¬æ—¶é—´
        CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M')
        
        # å¼ºåˆ¶è¦†ç›–ä¹‹å‰çš„æ–‡ä»¶
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add -f 91ktv.m3u
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç›´æ’­æº - ${CURRENT_TIME} åŒ—äº¬æ—¶é—´ (å·²å½’ç±»)" || echo "æ— å˜åŒ–"
        git push --force

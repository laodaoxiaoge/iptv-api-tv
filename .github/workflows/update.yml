name: 91ktvç›´æ’­æºæ¯æ—¥æ›´æ–°
on: 
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©UTCæ—¶é—´3ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´11ç‚¹ï¼‰

jobs:
  generate-and-overwrite:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: å®‰è£…ä¾èµ–
      run: npm install axios crypto-js

    - name: ç”Ÿæˆç›´æ’­æºæ–‡ä»¶
      run: |
        # åˆ›å»ºç›´æ¥è§†é¢‘æµç”Ÿæˆè„šæœ¬
        cat > generate.js << 'EOF'
        const axios = require('axios');
        const CryptoJS = require('crypto-js');
        const fs = require('fs');
        
        // è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        function getBeijingTime() {
          const now = new Date();
          const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
          return beijingTime.toISOString().replace('T', ' ').replace(/\.\d+Z/, '');
        }
        
        // è·å–çœŸæ­£çš„è§†é¢‘æµåœ°å€
        async function getRealStreamUrl(sourceUrl) {
          try {
            // å¤„ç†è‡ªå®šä¹‰åè®®
            if (sourceUrl.startsWith('kdsvod://')) {
              sourceUrl = sourceUrl.replace('kdsvod://', '');
            }
            
            // å¤„ç†åŠ å¯†URL
            if (sourceUrl.includes('pwd=jsdecode') && sourceUrl.includes('id=')) {
              const urlObj = new URL(sourceUrl);
              const id = urlObj.searchParams.get('id');
              const bt = urlObj.searchParams.get('bt');
              
              const nwtime = Math.floor(Date.now() / 1000);
              const params = {
                app: 'com.jiaoxiang.fangnale',
                version: '2.3.4',
                mac: 'fu:ck:92:92:ff',
                utk: '',
                nwtime: nwtime,
                ev: '20250113'
              };
              
              const appendStr = 'ahkajfkahlajjaflfakhfakfbuyaozaigaolefuquqikangbuzhu';
              let signStr = id;
              
              Object.keys(params).forEach(key => {
                if (key === 'tmk') return;
                signStr += (key === 'app') ? params[key] + appendStr : params[key];
              });
              
              params.sign = CryptoJS.MD5(signStr).toString();
              
              // æ„å»ºçœŸå®è§†é¢‘æµURL
              let realUrl = `${urlObj.origin}${urlObj.pathname}?`;
              if (bt) realUrl += `bt=${bt}&`;
              realUrl += `id=${id}`;
              Object.keys(params).forEach(k => {
                realUrl += `&${k}=${encodeURIComponent(params[k])}`;
              });
              
              return realUrl;
            }
            
            return sourceUrl;
          } catch (e) {
            console.error('è§£æè§†é¢‘æµåœ°å€å¤±è´¥:', e.message);
            return sourceUrl;
          }
        }
        
        // ä¸»å‡½æ•°
        (async () => {
          console.log('å¼€å§‹ç”Ÿæˆ91çœ‹ç”µè§†ç›´æ’­æº...');
          const updateTime = getBeijingTime();
          
          // æ ¸å¿ƒåˆ†ç±»
          const categories = [
            'å¤®è§†', 'å«è§†', 'é«˜æ¸…', '4K', 'å½±è§†', 'ä½“è‚²', 'æ–°é—»'
          ];
          
          let m3uContent = '#EXTM3U\n';
          // æ·»åŠ æ–‡ä»¶å¤´æ³¨é‡Šï¼ŒåŒ…å«æ›´æ–°æ—¶é—´
          m3uContent += `# 91KTVç›´æ’­æº - æœ€åæ›´æ–°: ${updateTime} (åŒ—äº¬æ—¶é—´)\n`;
          m3uContent += `# é¢‘é“æ€»æ•°: \n`;
          m3uContent += `# æºæ€»æ•°: \n`;
          m3uContent += `# ç”Ÿæˆæ–¹å¼: GitHub Actionsè‡ªåŠ¨æ›´æ–°\n\n`;
          
          let channelCount = 0;
          let sourceCount = 0;
          
          // å¹¶è¡Œå¤„ç†æ‰€æœ‰åˆ†ç±»
          await Promise.all(categories.map(async (category) => {
            console.log(`å¼€å§‹å¤„ç†åˆ†ç±»: ${category}`);
            
            try {
              // è·å–é¢‘é“åˆ—è¡¨ - æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„APIé“¾æ¥
              const channelsRes = await axios.get(
                `YOUR_API_URL_1${encodeURIComponent(category)}`, // æ›¿æ¢ä¸ºå®é™…é“¾æ¥
                { timeout: 5000, headers: {'User-Agent': 'Mozilla/5.0'} }
              );
              
              if (!channelsRes.data || !Array.isArray(channelsRes.data)) {
                console.log(`åˆ†ç±» ${category} æ— æ•°æ®`);
                return;
              }
              
              console.log(`åˆ†ç±» ${category} æœ‰ ${channelsRes.data.length} ä¸ªé¢‘é“`);
              
              // å¤„ç†æ¯ä¸ªé¢‘é“
              for (const channel of channelsRes.data) {
                const nwtime = Math.floor(Date.now() / 1000);
                const srcKey = `${channel.ename}com.jiaoxiang.fangnaleahkajfkahlajjaflfakhfakfbuyaozaigaolefuquqikangbuzhu2.3.4fu:ck:92:92:ff${nwtime}20240918`;
                const sign = CryptoJS.MD5(srcKey).toString();
                
                try {
                  // è·å–æ’­æ”¾æº - æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„APIé“¾æ¥
                  const sourceRes = await axios.get(
                    `YOUR_API_URL_2${channel.ename}&app=com.jiaoxiang.fangnale&version=2.3.4&mac=fu:ck:92:92:ff&nwtime=${nwtime}&sign=${sign}&ev=20240918`, // æ›¿æ¢ä¸ºå®é™…é“¾æ¥
                    { timeout: 5000, headers: {'User-Agent': 'Mozilla/5.0'} }
                  );
                  
                  // æ£€æŸ¥æ˜¯å¦æœ‰æ’­æ”¾æº
                  if (sourceRes.data?.liveSource && Array.isArray(sourceRes.data.liveSource)) {
                    const sources = sourceRes.data.liveSource;
                    const sourceNames = sourceRes.data.liveSourceName || [];
                    
                    // å¤„ç†æ¯ä¸ªæ’­æ”¾æº
                    for (let i = 0; i < sources.length; i++) {
                      let sourceUrl = sources[i];
                      
                      // è·å–çœŸæ­£çš„è§†é¢‘æµåœ°å€
                      const realStreamUrl = await getRealStreamUrl(sourceUrl);
                      
                      // æ·»åŠ æ›´æ–°æ—¶é—´ä¿¡æ¯åˆ°é¢‘é“åç§°
                      const sourceName = sourceNames[i] ? ` (${sourceNames[i]})` : '';
                      
                      m3uContent += `#EXTINF:-1 tvg-id="${channel.ename}" tvg-name="${channel.name}${sourceName}" tvg-logo="${channel.icon}" group-title="${category}",${channel.name}${sourceName}\n`;
                      m3uContent += `${realStreamUrl}\n`;
                      sourceCount++;
                    }
                    
                    channelCount++;
                  }
                } catch (e) {
                  console.log(`è·³è¿‡é¢‘é“ ${channel.name}: ${e.message}`);
                }
                
                // çŸ­æš‚å»¶è¿Ÿ
                await new Promise(r => setTimeout(r, 50));
              }
            } catch (e) {
              console.log(`å¤„ç†åˆ†ç±» ${category} å‡ºé”™: ${e.message}`);
            }
          }));
          
          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          m3uContent = m3uContent.replace('# é¢‘é“æ€»æ•°: \n', `# é¢‘é“æ€»æ•°: ${channelCount}\n`);
          m3uContent = m3uContent.replace('# æºæ€»æ•°: \n', `# æºæ€»æ•°: ${sourceCount}\n`);
          
          // è¦†ç›–å†™å…¥æ–‡ä»¶
          fs.writeFileSync('91ktv.m3u', m3uContent);
          console.log(`å®Œæˆ! å…±è·å– ${channelCount} ä¸ªé¢‘é“ï¼Œ${sourceCount} ä¸ªè§†é¢‘æµï¼Œæ›´æ–°æ—¶é—´: ${updateTime}`);
        })().catch(console.error);
        EOF
        
        # è¿è¡Œç”Ÿæˆè„šæœ¬
        node generate.js

    - name: è¦†ç›–æ›´æ–°æ–‡ä»¶
      run: |
        # è·å–å½“å‰åŒ—äº¬æ—¶é—´
        CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M')
        
        # å¼ºåˆ¶è¦†ç›–ä¹‹å‰çš„æ–‡ä»¶
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add -f 91ktv.m3u
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç›´æ’­æº - ${CURRENT_TIME} åŒ—äº¬æ—¶é—´" || echo "æ— å˜åŒ–"
        git push --force

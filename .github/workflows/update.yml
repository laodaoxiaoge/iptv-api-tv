name: 91ktvç›´æ’­æºæ¯æ—¥æ›´æ–°
on: 
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©UTCæ—¶é—´3ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´11ç‚¹ï¼‰

jobs:
  generate-and-overwrite:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: å®‰è£…ä¾èµ–
      run: npm install axios crypto-js

    - name: ç”Ÿæˆç›´æ’­æºæ–‡ä»¶
      run: |
        # åˆ›å»ºä¿®å¤ç‰ˆç”Ÿæˆè„šæœ¬
        cat > generate.js << 'EOF'
        const axios = require('axios');
        const CryptoJS = require('crypto-js');
        const fs = require('fs');
        
        // è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        function getBeijingTime() {
          const now = new Date();
          const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
          return beijingTime.toISOString().replace('T', ' ').replace(/\.\d+Z/, '');
        }
        
        // ä¸»å‡½æ•°
        (async () => {
          console.log('å¼€å§‹ç”Ÿæˆ91çœ‹ç”µè§†ç›´æ’­æº...');
          const updateTime = getBeijingTime();
          
          // ä½¿ç”¨æ­£ç¡®çš„åˆ†ç±»åˆ—è¡¨
          const categories = [
            'å¤®è§†', 'å«è§†', 'é«˜æ¸…', '4K', 'å½±è§†', 'ä½“è‚²', 'æ–°é—»', 'è´¢ç»', 'ç»¼è‰º'
          ];
          
          let m3uContent = '#EXTM3U\n';
          m3uContent += `# 91KTVç›´æ’­æº - æœ€åæ›´æ–°: ${updateTime} (åŒ—äº¬æ—¶é—´)\n`;
          
          let channelCount = 0;
          let sourceCount = 0;
          
          console.log('å¼€å§‹è·å–é¢‘é“æ•°æ®...');
          
          try {
            // ç›´æ¥æµ‹è¯•è·å–å¤®è§†åˆ†ç±»
            const testCategory = 'å¤®è§†';
            console.log(`æµ‹è¯•è·å–åˆ†ç±»: ${testCategory}`);
            
            // ä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹
            const channelsRes = await axios.get(
              `http://sj.91kds.cn/api/get_channel.php?id=${encodeURIComponent(testCategory)}`,
              { 
                timeout: 10000, 
                headers: {
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                  'Referer': 'http://www.91kds.cn/',
                  'Accept': 'application/json, text/plain, */*'
                }
              }
            );
            
            console.log('APIå“åº”çŠ¶æ€:', channelsRes.status);
            console.log('å“åº”æ•°æ®:', JSON.stringify(channelsRes.data).substring(0, 200));
            
            if (channelsRes.data && Array.isArray(channelsRes.data)) {
              console.log(`æˆåŠŸè·å–åˆ° ${channelsRes.data.length} ä¸ªé¢‘é“`);
              
              // å¤„ç†å‰å‡ ä¸ªé¢‘é“ä½œä¸ºæµ‹è¯•
              for (let i = 0; i < Math.min(5, channelsRes.data.length); i++) {
                const channel = channelsRes.data[i];
                console.log(`å¤„ç†é¢‘é“: ${channel.name}`);
                
                try {
                  const nwtime = Math.floor(Date.now() / 1000);
                  const srcKey = `${channel.ename}com.jiaoxiang.fangnaleahkajfkahlajjaflfakhfakfbuyaozaigaolefuquqikangbuzhu2.3.4fu:ck:92:92:ff${nwtime}20240918`;
                  const sign = CryptoJS.MD5(srcKey).toString();
                  
                  // è·å–æ’­æ”¾æº
                  const sourceRes = await axios.get(
                    `http://sjapi1.91kds.cn/api/get_source.php?ename=${channel.ename}&app=com.jiaoxiang.fangnale&version=2.3.4&mac=fu:ck:92:92:ff&nwtime=${nwtime}&sign=${sign}&ev=20240918`,
                    { 
                      timeout: 10000,
                      headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                        'Referer': 'http://www.91kds.cn/'
                      }
                    }
                  );
                  
                  if (sourceRes.data && sourceRes.data.liveSource && Array.isArray(sourceRes.data.liveSource)) {
                    const sources = sourceRes.data.liveSource;
                    const sourceNames = sourceRes.data.liveSourceName || [];
                    
                    console.log(`é¢‘é“ ${channel.name} æœ‰ ${sources.length} ä¸ªæ’­æ”¾æº`);
                    
                    // æ·»åŠ æ¯ä¸ªæ’­æ”¾æº
                    for (let j = 0; j < sources.length; j++) {
                      let sourceUrl = sources[j];
                      
                      // ç®€å•çš„URLå¤„ç†
                      if (sourceUrl.startsWith('kdsvod://')) {
                        sourceUrl = sourceUrl.replace('kdsvod://', '');
                      }
                      
                      const sourceName = sourceNames[j] ? ` (${sourceNames[j]})` : '';
                      
                      m3uContent += `#EXTINF:-1 tvg-id="${channel.ename}" tvg-name="${channel.name}${sourceName}" tvg-logo="${channel.icon}" group-title="${testCategory}",${channel.name}${sourceName}\n`;
                      m3uContent += `${sourceUrl}\n`;
                      sourceCount++;
                    }
                    
                    channelCount++;
                  } else {
                    console.log(`é¢‘é“ ${channel.name} æ— æ’­æ”¾æºæ•°æ®`);
                  }
                } catch (sourceError) {
                  console.log(`è·å–é¢‘é“ ${channel.name} çš„æ’­æ”¾æºå¤±è´¥:`, sourceError.message);
                }
                
                // çŸ­æš‚å»¶è¿Ÿ
                await new Promise(r => setTimeout(r, 100));
              }
            } else {
              console.log('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
              // æ·»åŠ æµ‹è¯•æ•°æ®ä»¥ç¡®ä¿æ–‡ä»¶ä¸ä¸ºç©º
              m3uContent += `#EXTINF:-1 tvg-id="TEST" tvg-name="æµ‹è¯•é¢‘é“" tvg-logo="" group-title="æµ‹è¯•",æµ‹è¯•é¢‘é“\n`;
              m3uContent += `http://example.com/test.m3u8\n`;
              channelCount = 1;
              sourceCount = 1;
            }
          } catch (error) {
            console.error('è·å–é¢‘é“åˆ—è¡¨å¤±è´¥:', error.message);
            // æ·»åŠ æµ‹è¯•æ•°æ®
            m3uContent += `#EXTINF:-1 tvg-id="TEST" tvg-name="æµ‹è¯•é¢‘é“" tvg-logo="" group-title="æµ‹è¯•",æµ‹è¯•é¢‘é“\n`;
            m3uContent += `http://example.com/test.m3u8\n`;
            channelCount = 1;
            sourceCount = 1;
          }
          
          // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          m3uContent += `\n# é¢‘é“æ€»æ•°: ${channelCount}\n`;
          m3uContent += `# æºæ€»æ•°: ${sourceCount}\n`;
          m3uContent += `# ç”Ÿæˆæ–¹å¼: GitHub Actionsè‡ªåŠ¨æ›´æ–°\n`;
          
          // å†™å…¥æ–‡ä»¶
          fs.writeFileSync('91ktv.m3u', m3uContent);
          console.log(`å®Œæˆ! å…±è·å– ${channelCount} ä¸ªé¢‘é“ï¼Œ${sourceCount} ä¸ªè§†é¢‘æµ`);
          console.log('æ–‡ä»¶å·²ä¿å­˜: 91ktv.m3u');
        })().catch(console.error);
        EOF
        
        # è¿è¡Œç”Ÿæˆè„šæœ¬
        node generate.js

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶å†…å®¹ ==="
        head -20 91ktv.m3u
        echo "=== æ–‡ä»¶å¤§å° ==="
        ls -la 91ktv.m3u

    - name: è¦†ç›–æ›´æ–°æ–‡ä»¶
      run: |
        # è·å–å½“å‰åŒ—äº¬æ—¶é—´
        CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M')
        
        # å¼ºåˆ¶è¦†ç›–ä¹‹å‰çš„æ–‡ä»¶
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add -f 91ktv.m3u
        git commit -m "ğŸ”„ ä¿®å¤ç‰ˆç›´æ’­æº - ${CURRENT_TIME} åŒ—äº¬æ—¶é—´" || echo "æ— å˜åŒ–"
        git push --force
